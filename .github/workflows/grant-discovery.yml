name: Weekly Grant Discovery

on:
  schedule:
    # Run every Monday at 6am UTC (5pm AEDT, 7am CET)
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      run_all:
        description: 'Run all operations (discover + archive + clean)'
        required: false
        default: 'true'
        type: boolean

env:
  NODE_VERSION: '20'

jobs:
  discover-grants:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    outputs:
      new_discoveries: ${{ steps.run-discovery.outputs.new_discoveries }}
      total_in_feed: ${{ steps.run-discovery.outputs.total_in_feed }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run grant discovery
        id: run-discovery
        run: |
          # Run the discovery script
          if [[ "${{ github.event.inputs.run_all }}" == "true" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            node scripts/scrape-grants.js --all 2>&1 | tee discovery-output.txt
          else
            node scripts/scrape-grants.js --discover 2>&1 | tee discovery-output.txt
          fi

          # Extract metrics from output
          NEW_DISCOVERIES=$(grep "New discoveries:" discovery-output.txt | grep -oE '[0-9]+' || echo "0")
          TOTAL_IN_FEED=$(grep "Total in feed:" discovery-output.txt | grep -oE '[0-9]+' || echo "0")

          echo "new_discoveries=$NEW_DISCOVERIES" >> $GITHUB_OUTPUT
          echo "total_in_feed=$TOTAL_IN_FEED" >> $GITHUB_OUTPUT

          # Save output for later steps
          echo "NEW_DISCOVERIES=$NEW_DISCOVERIES" >> $GITHUB_ENV
          echo "TOTAL_IN_FEED=$TOTAL_IN_FEED" >> $GITHUB_ENV
        env:
          NODE_ENV: production

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code data/ || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/

          # Create detailed commit message
          COMMIT_MSG="chore: Update grants data [automated]

          Weekly grant discovery completed:
          - New discoveries: ${{ env.NEW_DISCOVERIES }}
          - Total in feed: ${{ env.TOTAL_IN_FEED }}
          - Run timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          Sources checked: 12 grant portals across AU, NL, EU, PE"

          git commit -m "$COMMIT_MSG"
          git push

      - name: Create issue for new discoveries
        if: env.NEW_DISCOVERIES != '0' && env.NEW_DISCOVERIES != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read the discovery output
            let output = '';
            try {
              output = fs.readFileSync('discovery-output.txt', 'utf8');
            } catch (e) {
              output = 'Could not read discovery output';
            }

            // Extract new discoveries section
            const newDiscoveriesMatch = output.match(/New discoveries:[\s\S]*?(?=Errors|Completed|$)/);
            const newDiscoveries = newDiscoveriesMatch ? newDiscoveriesMatch[0] : 'See discovery log for details';

            const issueBody = `## üîî New Grant Opportunities Discovered

            The weekly grant discovery scan found **${{ env.NEW_DISCOVERIES }}** new potential opportunities.

            ### Summary
            - **New discoveries**: ${{ env.NEW_DISCOVERIES }}
            - **Total in review queue**: ${{ env.TOTAL_IN_FEED }}
            - **Scan completed**: ${new Date().toISOString()}

            ### Discovered Opportunities
            \`\`\`
            ${newDiscoveries.substring(0, 2000)}
            \`\`\`

            ### Next Steps
            1. Review the new discoveries in the [dashboard](/dashboard)
            2. Check the Review Queue tab for all pending grants
            3. Star promising opportunities to track them
            4. Dismiss irrelevant discoveries

            ---
            *This issue was automatically created by the grant discovery workflow.*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîî ${process.env.NEW_DISCOVERIES} New Grant Opportunities - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['grant-discovery', 'automated']
            });

      - name: Generate summary
        run: |
          echo "## üìä Grant Discovery Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Run completed | $(date -u) |" >> $GITHUB_STEP_SUMMARY
          echo "| New discoveries | ${{ env.NEW_DISCOVERIES }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Total in feed | ${{ env.TOTAL_IN_FEED }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "data/grants-feed.json" ]; then
            echo "### Feed Status" >> $GITHUB_STEP_SUMMARY
            FEED_COUNT=$(cat data/grants-feed.json | jq length)
            echo "- Grants in review queue: $FEED_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "data/grants-tracked.json" ]; then
            TRACKED_COUNT=$(cat data/grants-tracked.json | jq length)
            echo "- Grants being tracked: $TRACKED_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "data/grants-archive.json" ]; then
            ARCHIVED_COUNT=$(cat data/grants-archive.json | jq length)
            echo "- Archived grants: $ARCHIVED_COUNT" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sources Checked" >> $GITHUB_STEP_SUMMARY
          echo "- üá≥üá± Netherlands: 5 sources" >> $GITHUB_STEP_SUMMARY
          echo "- üá™üá∫ EU-wide: 3 sources" >> $GITHUB_STEP_SUMMARY
          echo "- üá¶üá∫ Australia: 2 sources" >> $GITHUB_STEP_SUMMARY
          echo "- üáµüá™ Peru/Indigenous: 2 sources" >> $GITHUB_STEP_SUMMARY

  # Optional: Notify on failure
  notify-failure:
    runs-on: ubuntu-latest
    needs: discover-grants
    if: failure()

    steps:
      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è Grant Discovery Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Grant Discovery Workflow Failed

              The weekly grant discovery workflow encountered an error.

              **Run ID**: ${{ github.run_id }}
              **Timestamp**: ${new Date().toISOString()}

              Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

              ---
              *This issue was automatically created due to a workflow failure.*
              `,
              labels: ['bug', 'grant-discovery', 'automated']
            });
